// Generated by CoffeeScript 1.6.3
var activateConsole, activatePageActionTab, activatePageActionTabs, checkForValidUrl, grabCookies;

checkForValidUrl = function(tabId, changeInfo, tab) {
  if (/.*feedly.com.*/.test(tab.url)) {
    console.log("checkForValidUrl " + tab.id + "/" + tab.url);
    return activatePageActionTab(tab);
  }
};

activatePageActionTab = function(tab) {
  var action, msg;
  msg = "show pageAction icon and send url " + tab.url + " to " + tab.id;
  action = "icon_active";
  console.log(msg);
  chrome.pageAction.show(tab.id);
  chrome.tabs.sendMessage(tab.id, {
    action: action,
    url: tab.url,
    id: tab.id,
    msg: msg
  }, function(response) {
    return console.log("response: " + msg);
  });
  return grabCookies(tab);
};

activatePageActionTabs = function(tabs) {
  return tabs.forEach(activatePageActionTab);
};

activateConsole = function(tab) {
  var action, msg;
  msg = "toggle console " + tab.url + " to " + tab.id;
  action = "toggle_console";
  console.log(msg);
  chrome.tabs.sendMessage(tab.id, {
    action: action,
    url: tab.url,
    id: tab.id,
    msg: msg
  }, function(response) {
    return console.log("response: " + msg);
  });
  return grabCookies(tab);
};

grabCookies = function(tab) {
  var domain, filter;
  domain = tab.url.split("/")[2];
  filter = {
    name: "session@cloud",
    domain: domain
  };
  return chrome.cookies.getAll(filter, function(cookies) {
    var action, i, msg, values, _results;
    _results = [];
    for (i in cookies) {
      values = JSON.parse(cookies[i].value);
      action = "cookie_feedlytoken";
      msg = action + " " + tab.url + " to " + tab.id + " " + filter;
      console.log(msg);
      _results.push(chrome.tabs.sendMessage(tab.id, {
        action: action,
        url: tab.url,
        id: tab.id,
        feedlytoken: values.feedlyToken,
        msg: msg
      }, function(response) {
        return console.log("response: " + msg);
      }));
    }
    return _results;
  });
};

chrome.pageAction.onClicked.addListener(activateConsole);

chrome.commands.onCommand.addListener(function(command) {
  return console.log("Command:", command);
});

chrome.tabs.onUpdated.addListener(checkForValidUrl);

chrome.tabs.query({
  url: "*://*.feedly.com/*"
}, activatePageActionTabs);

/*
//@ sourceMappingURL=background.map
*/
